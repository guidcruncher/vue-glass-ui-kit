const fastify = require('fastify')({
  logger: true
});

const PORT = 3000;

/**
 * Image Proxy Route
 * Fetches an external image URL and streams it back to the client.
 */
fastify.get('/api/proxy-image', async (request, reply) => {
    const imageUrl = request.query.url;

    if (!imageUrl) {
        reply.code(400).send('Missing image URL parameter.');
        return;
    }
    
    // Optional: Add security check here (e.g., validate the imageUrl domain)

    try {
        // Use the native fetch API (provided by undici or built into Node.js >= 18)
        const response = await fetch(imageUrl);

        if (!response.ok) {
            request.log.error(`Failed to fetch external image: ${response.status} ${response.statusText}`);
            reply.code(response.status).send('Failed to fetch external image.');
            return;
        }

        // Set the appropriate headers from the original image response
        const contentType = response.headers.get('content-type') || 'image/jpeg';
        
        reply
            // 1. Set the correct Content-Type (critical for the browser/canvas)
            .header('Content-Type', contentType)
            // 2. Set Access-Control-Allow-Origin (optional, but good practice)
            .header('Access-Control-Allow-Origin', '*')
            // 3. Set Cache control
            .header('Cache-Control', 'public, max-age=31536000')
            // 4. Stream the body directly for high performance (Fastify handles piping)
            .send(response.body);

    } catch (error) {
        request.log.error('Proxy operation failed:', error);
        reply.code(500).send('Internal server error during proxy operation.');
    }
});


// Start the server
const start = async () => {
  try {
    await fastify.listen({ port: PORT, host: '0.0.0.0' });
    fastify.log.info(`Fastify Image Proxy running on http://localhost:${PORT}`);
  } catch (err) {
    fastify.log.error(err);
    process.exit(1);
  }
};
start();
